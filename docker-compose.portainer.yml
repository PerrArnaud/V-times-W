version: '3.8'

services:
  app:
    image: dunglas/frankenphp:latest-php8.3
    restart: unless-stopped
    ports:
      - "8090:80"
      - "8453:443"
    volumes:
      - app_data:/app
    working_dir: /app
    environment:
      - GITHUB_REPO=${GITHUB_REPO:-https://github.com/votre-username/votre-repo.git}
      - GITHUB_BRANCH=${GITHUB_BRANCH:-main}
      - APP_ENV=prod
      - DATABASE_URL=${DATABASE_URL}
      - SERVER_NAME=:80
    entrypoint: /bin/sh
    command: >
      -c "
        apk add --no-cache git &&
        if [ ! -d /app/.git ]; then
          git clone --depth 1 --branch $${GITHUB_BRANCH} $${GITHUB_REPO} /app
        fi &&
        cd /app &&
        git pull origin $${GITHUB_BRANCH} &&
        composer install --no-dev --optimize-autoloader --no-interaction &&
        php bin/console cache:clear --no-interaction &&
        php bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration &&
        frankenphp run --config /app/frankenphp/Caddyfile
      "
    networks:
      - v-times-w_default
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  app_data:

networks:
  v-times-w_default:
    external: true  # Utilise le r√©seau existant
